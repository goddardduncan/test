<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Battery Logic Debugger</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .test-card { border: 1px solid #333; padding: 15px; border-radius: 8px; background: #222; }
        .test-num { color: #ff3e3e; font-weight: bold; }
        .val { font-size: 24px; margin-top: 10px; color: #fff; }
        .desc { font-size: 11px; color: #888; margin-top: 5px; }
        button { background: #e30613; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        #raw-hex { background: #000; padding: 10px; margin-bottom: 20px; border: 1px solid #444; word-break: break-all; }
    </style>
</head>
<body>

    <h2>RAPT Battery Debug Suite</h2>
    <button id="scanBtn">Start Debug Scan</button>
    
    <div id="raw-hex">Raw Payload (Hex): Waiting...</div>

    <div class="grid" id="results">
        </div>

<script>
    const scanBtn = document.getElementById('scanBtn');
    const resultsDiv = document.getElementById('results');
    const rawDiv = document.getElementById('raw-hex');

    const solutions = [
        { id: 1, name: "The Standard", desc: "Int16 Big Endian / 256 (As per Python docs)" },
        { id: 2, name: "The Unsigned", desc: "Uint16 / 256 (Ignores negative bit)" },
        { id: 3, name: "The Little Endian", desc: "Int16 Little Endian / 256" },
        { id: 4, name: "Byte Swap", desc: "Read index 22 then 21 manually" },
        { id: 5, name: "Bit Shift Right", desc: "Int16 >> 8 (Extracting High Byte only)" },
        { id: 6, name: "Direct Uint8", desc: "Reading index 21 as a single byte" },
        { id: 7, name: "Voltage Map", desc: "Assuming raw is mV (e.g. 4200) -> 0-100%" },
        { id: 8, name: "The Mask", desc: "Applying 0x00FF mask to Int16" },
        { id: 9, name: "The Aggressive Clamp", desc: "Solution 1 but force 1-100 (Never 0)" }
    ];

    // Initialize UI
    solutions.forEach(s => {
        resultsDiv.innerHTML += `
            <div class="test-card">
                <div class="test-num">#${s.id} ${s.name}</div>
                <div class="val" id="val-${s.id}">--%</div>
                <div class="desc">${s.desc}</div>
            </div>`;
    });

    scanBtn.onclick = async () => {
        try {
            const scan = await navigator.bluetooth.requestLEScan({
                filters: [{ manufacturerData: [{ companyIdentifier: 16722 }] }],
                keepRepeatedDevices: true
            });

            navigator.bluetooth.addEventListener('advertisementreceived', event => {
                const mData = event.manufacturerData.get(16722);
                if (mData && mData.byteLength === 23) {
                    const view = new DataView(mData.buffer);
                    const raw = Array.from(new Uint8Array(mData.buffer)).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    rawDiv.innerText = `Raw Payload: ${raw}`;

                    const b_int16_be = view.getInt16(21, false);
                    const b_uint16_be = view.getUint16(21, false);
                    const b_int16_le = view.getInt16(21, true);

                    // #1 Standard
                    update(1, Math.round(b_int16_be / 256));
                    
                    // #2 Unsigned
                    update(2, Math.round(b_uint16_be / 256));
                    
                    // #3 Little Endian
                    update(3, Math.round(b_int16_le / 256));

                    // #4 Byte Swap
                    const swapped = (view.getUint8(22) << 8) | view.getUint8(21);
                    update(4, Math.round(swapped / 256));

                    // #5 Shift
                    update(5, b_int16_be >> 8);

                    // #6 Direct Byte
                    update(6, view.getUint8(21));

                    // #7 Voltage Assumption (Assuming 3000mv - 4200mv range)
                    const v = b_int16_be;
                    let pct = ((v - 3000) / (4200 - 3000)) * 100;
                    update(7, v > 100 ? Math.round(pct) : "Range Err");

                    // #8 Mask
                    update(8, (b_int16_be & 0x00FF));

                    // #9 Aggressive Clamp
                    let c = Math.round(b_int16_be / 256);
                    update(9, c <= 0 ? "FORCE 1" : c);
                }
            });
        } catch (e) { alert(e); }
    };

    function update(id, val) {
        const el = document.getElementById(`val-${id}`);
        el.innerText = typeof val === 'number' ? val + "%" : val;
    }
</script>
</body>
</html>
