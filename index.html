<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPT Pill | Pro Station</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        :root { --kl-red: #e30613; --kl-dark: #1a1a1a; --kl-grey: #2d2d2d; --kl-text: #ffffff; --kl-muted: #a0a0a0; }
        body { font-family: 'Roboto', sans-serif; background: var(--kl-dark); margin: 0; padding: 15px; color: var(--kl-text); display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; }
        header { border-left: 4px solid var(--kl-red); padding-left: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .status-bar { background: var(--kl-grey); padding: 8px 15px; border-radius: 4px; font-size: 11px; margin-bottom: 15px; display: flex; justify-content: space-between; border: 1px solid #333; }
        .dot { height: 8px; width: 8px; background-color: #444; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active .dot { background-color: var(--kl-red); box-shadow: 0 0 8px var(--kl-red); }
        
        #dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: var(--kl-grey); padding: 15px; border-radius: 8px; border-bottom: 3px solid #333; text-align: center; }
        .value { font-size: 24px; font-weight: 700; font-family: monospace; }
        .label { font-size: 10px; color: var(--kl-red); text-transform: uppercase; font-weight: bold; }

        .chart-container { background: var(--kl-grey); padding: 15px; border-radius: 8px; margin-bottom: 15px; height: 250px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        button { padding: 12px; font-size: 12px; cursor: pointer; border: none; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .btn-main { background: var(--kl-red); color: white; }
        .btn-sub { background: #444; color: white; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--kl-grey); margin: 10% auto; padding: 25px; border-radius: 8px; width: 320px; border: 1px solid var(--kl-red); }
        input, select { width: 100%; padding: 10px; margin: 10px 0; background: #111; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .history-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #444; }
        .history-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 13px; }
        .history-item:hover { background: #333; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div><h1>RAPT Pill</h1><p style="color:var(--kl-muted); font-size:12px; margin:0;">Pro Logging Station</p></div>
        <div id="brewNameDisplay" style="color:var(--kl-red); font-weight:bold;">Current Batch</div>
    </header>

    <div id="statusBox" class="status-bar">
        <span><span class="dot"></span> <span id="statusText">DISCONNECTED</span></span>
        <span id="unitDisplay">SG</span>
    </div>

    <div id="dashboard">
        <div class="card"><div class="label" id="gLabel">Gravity</div><div class="value"><span id="gVal">--</span></div></div>
        <div class="card"><div class="label">Temp</div><div class="value"><span id="tVal">--</span><span style="font-size:12px">Â°C</span></div></div>
        <div class="card"><div class="label">Battery</div><div class="value"><span id="bVal">--</span><span style="font-size:12px">%</span></div></div>
    </div>

    <div class="chart-container"><canvas id="gravChart"></canvas></div>
    <div class="chart-container"><canvas id="tempChart"></canvas></div>

    <div class="controls">
        <button id="startBtn" class="btn-main">Connect</button>
        <button id="openSettings" class="btn-sub">Settings</button>
        <button id="openHistory" class="btn-sub">Brew History</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Settings</h3>
        <label>Units</label>
        <select id="unitSelect"><option value="SG">SG</option><option value="Plato">Plato</option></select>
        <label>Calibration Offset (SG)</label>
        <input type="number" id="offsetInput" step="0.0001">
        <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
        <button onclick="archiveCurrentBrew()" style="background:var(--kl-red); color:white; width:100%; margin-bottom:10px;">Archive & Reset Log</button>
        <button onclick="closeModals()" class="btn-sub" style="width:100%">Close</button>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content" style="width:400px">
        <h3>Brew History</h3>
        <div id="historyList" class="history-list"></div>
        <button onclick="closeModals()" class="btn-sub" style="width:100%">Close</button>
    </div>
</div>

<script>
    // State Management
    let logs = JSON.parse(localStorage.getItem('rapt_current_logs')) || [];
    let history = JSON.parse(localStorage.getItem('rapt_history')) || [];
    let offset = parseFloat(localStorage.getItem('rapt_offset')) || 0;
    let unit = localStorage.getItem('rapt_unit') || 'SG';
    let lastLogTime = 0;
    const LOG_INTERVAL = 15 * 60 * 1000; // 15 Minutes

    // Charts
    let gravChart, tempChart;

    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'hour' }, grid: { color: '#333' } },
                y: { grid: { color: '#333' }, ticks: { color: '#aaa' } }
            },
            plugins: { legend: { display: false } }
        };

        gravChart = new Chart(document.getElementById('gravChart'), {
            type: 'line',
            data: { datasets: [{ label: 'Gravity', data: [], borderColor: '#e30613', tension: 0.3, pointRadius: 2 }] },
            options: commonOptions
        });

        tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: { datasets: [{ label: 'Temp', data: [], borderColor: '#3498db', tension: 0.3, pointRadius: 2 }] },
            options: commonOptions
        });
        
        refreshCharts();
    }

    function refreshCharts() {
        const gData = logs.map(l => ({ x: l.t, y: unit === 'SG' ? l.g : l.p }));
        const tData = logs.map(l => ({ x: l.t, y: l.temp }));
        
        gravChart.data.datasets[0].data = gData;
        tempChart.data.datasets[0].data = tData;
        
        gravChart.update('none');
        tempChart.update('none');
    }

    function logData(sg, pl, temp) {
        const now = Date.now();
        if (now - lastLogTime > LOG_INTERVAL || logs.length === 0) {
            logs.push({ t: now, g: sg, p: pl, temp: temp });
            localStorage.setItem('rapt_current_logs', JSON.stringify(logs));
            lastLogTime = now;
            refreshCharts();
        }
    }

    function archiveCurrentBrew() {
        const name = prompt("Enter a name for this brew:", "Batch " + new Date().toLocaleDateString());
        if (!name) return;
        
        history.push({ name: name, date: new Date().toISOString(), data: [...logs], unit: unit });
        localStorage.setItem('rapt_history', JSON.stringify(history));
        
        logs = [];
        localStorage.setItem('rapt_current_logs', JSON.stringify(logs));
        refreshCharts();
        closeModals();
        alert("Brew Archived!");
    }

    function viewHistoryItem(index) {
        const item = history[index];
        logs = item.data;
        unit = item.unit || 'SG';
        document.getElementById('brewNameDisplay').innerText = "VIEWING: " + item.name;
        refreshCharts();
        closeModals();
    }

    // Bluetooth & Logic
    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click', async () => {
        try {
            const scan = await navigator.bluetooth.requestLEScan({
                filters: [{ manufacturerData: [{ companyIdentifier: 16722 }] }],
                keepRepeatedDevices: true
            });
            document.getElementById('statusBox').classList.add('active');
            document.getElementById('statusText').innerText = "SCANNING";
            startBtn.disabled = true;

            navigator.bluetooth.addEventListener('advertisementreceived', event => {
                const mData = event.manufacturerData.get(16722);
                if (mData && mData.byteLength === 23) {
                    const view = new DataView(mData.buffer);
                    const tRaw = (view.getUint16(9, false) / 128 - 273.15).toFixed(1);
                    const gRaw = (view.getFloat32(11, false) / 1000);
                    const bat = Math.round(view.getInt16(21, false) / 256);

                    const calSG = parseFloat((gRaw + offset).toFixed(4));
                    const calPlato = parseFloat(((-1*616.868) + (1111.14*calSG) - (630.272*Math.pow(calSG,2)) + (135.997*Math.pow(calSG,3))).toFixed(1));

                    document.getElementById('gVal').innerText = (unit === 'SG' ? calSG.toFixed(4) : calPlato);
                    document.getElementById('tVal').innerText = tRaw;
                    document.getElementById('bVal').innerText = bat;
                    
                    logData(calSG, calPlato, parseFloat(tRaw));
                }
            });
        } catch (e) { alert("Scan Failed: " + e); }
    });

    // UI Helpers
    function closeModals() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
    }
    
    document.getElementById('openSettings').onclick = () => {
        document.getElementById('offsetInput').value = offset;
        document.getElementById('unitSelect').value = unit;
        document.getElementById('settingsModal').style.display = 'block';
    };

    document.getElementById('openHistory').onclick = () => {
        const list = document.getElementById('historyList');
        list.innerHTML = history.length ? '' : '<div style="padding:10px">No history found.</div>';
        history.forEach((item, idx) => {
            const el = document.createElement('div');
            el.className = 'history-item';
            el.innerHTML = `<strong>${item.name}</strong><br><small>${new Date(item.date).toLocaleDateString()}</small>`;
            el.onclick = () => viewHistoryItem(idx);
            list.appendChild(el);
        });
        document.getElementById('historyModal').style.display = 'block';
    };

    document.getElementById('saveSettings').onclick = () => {
        offset = parseFloat(document.getElementById('offsetInput').value) || 0;
        unit = document.getElementById('unitSelect').value;
        localStorage.setItem('rapt_offset', offset);
        localStorage.setItem('rapt_unit', unit);
        document.getElementById('unitDisplay').innerText = unit;
        refreshCharts();
        closeModals();
    };

    // Init
    initCharts();
</script>
</body>
</html>
