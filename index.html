<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPT Pill | Battery Logic Suite</title>
    <style>
        :root { --kl-red: #e30613; --kl-dark: #1a1a1a; --kl-grey: #2d2d2d; --kl-text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--kl-dark); color: var(--kl-text); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: auto; }
        
        .header { border-left: 4px solid var(--kl-red); padding-left: 15px; margin-bottom: 20px; }
        .status-bar { background: #222; padding: 10px; border-radius: 4px; font-size: 11px; margin-bottom: 15px; display: flex; justify-content: space-between; border: 1px solid #333; }
        
        /* The 9-Cell Debug Grid */
        .debug-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .debug-card { background: var(--kl-grey); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #444; }
        .debug-card.active { border-color: var(--kl-red); background: #331111; }
        .b-val { font-size: 22px; font-weight: bold; display: block; }
        .b-label { font-size: 9px; color: #888; text-transform: uppercase; margin-top: 5px; line-height: 1.2; }
        
        button { width: 100%; background: var(--kl-red); color: white; border: none; padding: 15px; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #raw-hex { font-family: monospace; font-size: 10px; background: #000; padding: 10px; border-radius: 4px; margin-top: 15px; word-break: break-all; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0; font-size: 20px;">BATTERY DEBUG STATION</h1>
        <p style="margin:0; font-size: 12px; color: #888;">Testing 9 logic variants on index 21-22</p>
    </div>

    <button id="startBtn">Initiate Bluetooth Scan</button>

    <div id="status" class="status-bar">
        <span>STATUS: <strong id="state">IDLE</strong></span>
        <span id="timestamp">--:--:--</span>
    </div>

    <div class="debug-grid">
        <div class="debug-card"><span class="b-val" id="v1">--</span><div class="b-label">#1 Standard<br>(Int16 / 256)</div></div>
        <div class="debug-card"><span class="b-val" id="v2">--</span><div class="b-label">#2 Unsigned<br>(Uint16 / 256)</div></div>
        <div class="debug-card"><span class="b-val" id="v3">--</span><div class="b-label">#3 High Byte<br>(Uint8 @ 21)</div></div>
        <div class="debug-card"><span class="b-val" id="v4">--</span><div class="b-label">#4 Low Byte<br>(Uint8 @ 22)</div></div>
        <div class="debug-card"><span class="b-val" id="v5">--</span><div class="b-label">#5 Shift Logic<br>(Raw >> 8)</div></div>
        <div class="debug-card"><span class="b-val" id="v6">--</span><div class="b-label">#6 Masking<br>(Raw & 0xFF)</div></div>
        <div class="debug-card"><span class="b-val" id="v7">--</span><div class="b-label">#7 mV Scale<br>(3k-4.2k mV)</div></div>
        <div class="debug-card"><span class="b-val" id="v8">--</span><div class="b-label">#8 Float Conv<br>(Native Float)</div></div>
        <div class="debug-card"><span class="b-val" id="v9">--</span><div class="b-label">#9 Python Round<br>round(x / 256)</div></div>
    </div>

    <div style="background:#222; padding:15px; border-radius:6px; border: 1px solid #444;">
        <div style="font-size: 10px; color:var(--kl-red); margin-bottom:5px;">LIVE TELEMETRY</div>
        <div style="display:flex; justify-content: space-around; text-align: center;">
            <div><div class="b-label">GRAVITY</div><div style="font-size:20px" id="grav">--</div></div>
            <div><div class="b-label">TEMP</div><div style="font-size:20px" id="temp">--</div></div>
        </div>
    </div>

    <div id="raw-hex">HEX: No data received yet...</div>
</div>

<script>
    const startBtn = document.getElementById('startBtn');

    startBtn.onclick = async () => {
        try {
            const scan = await navigator.bluetooth.requestLEScan({
                filters: [{ manufacturerData: [{ companyIdentifier: 16722 }] }],
                keepRepeatedDevices: true
            });

            document.getElementById('state').innerText = "SCANNING...";
            document.getElementById('state').style.color = "#27ae60";

            navigator.bluetooth.addEventListener('advertisementreceived', event => {
                const mData = event.manufacturerData.get(16722);
                if (mData && mData.byteLength === 23) {
                    const view = new DataView(mData.buffer);
                    
                    // Standard Data
                    const t = (view.getUint16(9, false) / 128 - 273.15).toFixed(1);
                    const g = (view.getFloat32(11, false) / 1000).toFixed(4);
                    
                    document.getElementById('temp').innerText = t + "Â°C";
                    document.getElementById('grav').innerText = g;
                    document.getElementById('timestamp').innerText = new Date().toLocaleTimeString();
                    document.getElementById('raw-hex').innerText = "HEX: " + Array.from(new Uint8Array(mData.buffer)).map(b => b.toString(16).padStart(2, '0')).join(' ');

                    // Battery Logic Tests (Index 21/22)
                    const b_int16 = view.getInt16(21, false);
                    const b_uint16 = view.getUint16(21, false);

                    // #1 Standard (Old Logic)
                    setVal('v1', Math.round(b_int16 / 256));
                    
                    // #2 Unsigned 16
                    setVal('v2', Math.round(b_uint16 / 256));
                    
                    // #3 High Byte (Direct)
                    setVal('v3', view.getUint8(21));
                    
                    // #4 Low Byte (Direct)
                    setVal('v4', view.getUint8(22));
                    
                    // #5 Shift Logic
                    setVal('v5', b_int16 >> 8);
                    
                    // #6 Bit Mask
                    setVal('v6', b_int16 & 0xFF);
                    
                    // #7 Voltage Assumption (If value is mV like 4100)
                    let mvPct = Math.round(((b_int16 - 3400) / 800) * 100);
                    setVal('v7', b_int16 > 255 ? mvPct : "Low V");
                    
                    // #8 Float Interpretation (Unlikely but possible)
                    try { setVal('v8', Math.round(view.getFloat32(21, false))); } catch(e) { setVal('v8', "ERR"); }

                    // #9 Python Specific Logic (Rounding vs Floor)
                    setVal('v9', Math.round(Number(b_int16) / 256));
                }
            });
        } catch (e) {
            alert("Bluetooth Scan Blocked: Ensure Location is ON and Browser Permissions are granted.");
        }
    };

    function setVal(id, val) {
        const el = document.getElementById(id);
        el.innerText = val + (typeof val === 'number' ? "%" : "");
        if (val > 0 && val <= 100) el.parentElement.classList.add('active');
        else el.parentElement.classList.remove('active');
    }
</script>
</body>
</html>
